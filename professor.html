<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>👨‍🏫 Painel do Professor</title>
<link rel="stylesheet" href="style.css"/>
<script type="module">
  import { db } from "./firebase.js";
  import { collection, getDocs, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  let usuarioId = localStorage.getItem("usuarioId");
  if (!usuarioId) {
    window.location.href = "index.html";
  }

  async function carregarAlunos() {
    const querySnapshot = await getDocs(collection(db, "usuarios"));
    const lista = document.getElementById("listaAlunos");
    lista.innerHTML = "";
    querySnapshot.forEach((docSnap) => {
      const aluno = docSnap.data();
      if (aluno.tipo === "aluno") {
        lista.innerHTML += `
          <div class="card">
            <h3>${aluno.nome} (${aluno.turma})</h3>
            <p>💰 Saldo: ${aluno.saldo || 0}</p>
            <button onclick="alterarSaldo('${docSnap.id}', 1)">➕ Adicionar</button>
            <button onclick="alterarSaldo('${docSnap.id}', -1)">➖ Remover</button>
            <button onclick="verHistorico('${docSnap.id}', '${aluno.nome}')">📜 Histórico</button>
          </div>
        `;
      }
    });
  }

  window.alterarSaldo = async function(uid, valor) {
    const alunoRef = doc(db, "usuarios", uid);
    const alunosSnap = await getDocs(collection(db, "usuarios"));
    alunosSnap.forEach(async (u) => {
      if (u.id === uid) {
        const atual = u.data().saldo || 0;
        await updateDoc(alunoRef, { saldo: atual + valor });
        carregarAlunos();
      }
    });
  };

  // Função para visualizar histórico de compras
  window.verHistorico = async function(alunoId, alunoNome) {
    const q = query(collection(db, "historico"), where("alunoId", "==", alunoId));
    const querySnapshot = await getDocs(q);

    let mensagem = `📜 Histórico de compras de ${alunoNome}:\n\n`;
    querySnapshot.forEach((docSnap) => {
      const item = docSnap.data();
      const data = new Date(item.data).toLocaleString();
      mensagem += `• ${item.produto} | 💲 ${item.preco} | 🕒 ${data}\n`;
    });

    if (querySnapshot.empty) mensagem += "Nenhuma compra realizada.";

    alert(mensagem);
  };

  carregarAlunos();
</script>
</head>
<body>
  <header><h1>👨‍🏫 Painel do Professor</h1></header>
<main>
  <div style="text-align:center; margin-bottom:1rem;">
    <button onclick="window.location.href='professor-cadastro.html'">➕ Cadastrar Novo Usuário</button>
    <button onclick="window.location.href='professor-produtos.html'" style="margin-left:10px;">🛒 Cadastrar Produto</button>
    <button onclick="sair()" style="margin-left:10px;">🚪 Sair</button>
  </div>

  <div id="listaAlunos" class="grid"></div>
</main>


<script>
  function sair() {
    localStorage.removeItem("usuarioId");
    window.location.href = "index.html";
  }
</script>
</body>
</html>
